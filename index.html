<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAC FOODS Clinic Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/highcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/modules/exporting.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.2.0/themes/grid-light.min.js"></script>
    <style>
        :root {
    --primary-red: #DC2626;
    --primary-blue: #1E40AF;
    --light-gray: #F8FAFC;
    --dark-gray: #374151;
    --success-green: #10B981;
    --warning-yellow: #F59E0B;
    --white: #FFFFFF;
    
    /* Professional Typography Scale */
    --text-xs: 12px;
    --text-sm: 13px;
    --text-base: 14px;
    --text-md: 16px;
    --text-lg: 18px;
    --text-xl: 20px;
    --text-2xl: 24px;
    --text-3xl: 28px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
    min-height: 100vh;
    color: var(--dark-gray);
    font-size: var(--text-base);
    line-height: 1.6;
}

/* Typography Utilities */
.text-xs { font-size: var(--text-xs); }
.text-sm { font-size: var(--text-sm); }
.text-base { font-size: var(--text-base); }
.text-md { font-size: var(--text-md); }
.text-lg { font-size: var(--text-lg); }
.text-xl { font-size: var(--text-xl); }
.text-2xl { font-size: var(--text-2xl); }
.text-3xl { font-size: var(--text-3xl); }

/* Professional Headings */
h1 { font-size: var(--text-2xl); font-weight: 700; line-height: 1.3; }
h2 { font-size: var(--text-xl); font-weight: 600; line-height: 1.4; }
h3 { font-size: var(--text-lg); font-weight: 600; line-height: 1.4; }
h4 { font-size: var(--text-md); font-weight: 600; line-height: 1.5; }

.header {
    background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-blue) 100%);
    color: white;
    padding: 1rem 2rem;
    text-align: center;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shine 3s infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
    100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}

.logo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid white;
    margin: 0 auto 10px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xl);
    font-weight: bold;
    color: var(--primary-red);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.company-name {
    font-style: italic;
    font-size: var(--text-md);
    margin-bottom: 10px;
    opacity: 0.9;
}

.nav-tabs {
    background: var(--white);
    padding: 0;
    margin: 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-bottom: 3px solid var(--primary-blue);
}

.nav-tabs ul {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background: var(--white);
}

.nav-tabs li {
    margin: 0;
}

.nav-tabs button {
    background: none;
    border: none;
    padding: 15px 20px;
    cursor: pointer;
    font-size: var(--text-base);
    font-weight: 500;
    color: var(--dark-gray);
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.nav-tabs button:hover {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.nav-tabs button.active {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    border-bottom-color: var(--primary-blue);
}

.container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1rem;
}

.tab-content {
    display: none;
    background: var(--white);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    animation: fadeIn 0.5s ease-in;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--dark-gray);
    font-size: var(--text-base);
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 10px 14px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: var(--text-base);
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.btn {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: var(--text-base);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 5px;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.btn-secondary {
    background: linear-gradient(135deg, #6B7280, #4B5563);
}

.btn-success {
    background: linear-gradient(135deg, #10B981, #059669);
}

.search-container {
    background: var(--light-gray);
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border-left: 4px solid var(--primary-blue);
}

.patient-card {
    background: var(--white);
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-red);
    position: relative;
}

.patient-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    border-left-color: var(--primary-blue);
}

.patient-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.patient-name {
    font-size: var(--text-md);
    font-weight: 600;
    color: var(--primary-blue);
}

.patient-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.5rem;
    font-size: var(--text-sm);
    color: #6B7280;
}

.visit-count {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: var(--text-xs);
    font-weight: 500;
}

.patient-portal-header {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    padding: 2rem;
    border-radius: 12px 12px 0 0;
    margin: -2rem -2rem 2rem -2rem;
}

.portal-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: white;
    color: var(--primary-blue);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-2xl);
    font-weight: bold;
    margin: 0 auto 1rem;
    border: 4px solid white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.portal-basic-info {
    text-align: center;
}

.portal-name {
    font-size: var(--text-xl);
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.portal-subtitle {
    font-size: var(--text-md);
    opacity: 0.9;
    margin-bottom: 1rem;
}

.portal-stats {
    display: flex;
    justify-content: space-around;
    background: rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 1rem;
}

.portal-stat {
    text-align: center;
}

.portal-stat-number {
    font-size: var(--text-xl);
    font-weight: bold;
}

.portal-stat-label {
    font-size: var(--text-sm);
    opacity: 0.8;
}

.visit-timeline {
    position: relative;
    margin-left: 2rem;
}

.visit-timeline::before {
    content: '';
    position: absolute;
    left: -1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--primary-blue);
}

.timeline-item {
    position: relative;
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-left: 1rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -2rem;
    top: 1.5rem;
    width: 12px;
    height: 12px;
    background: var(--primary-red);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 0 2px var(--primary-blue);
}

.timeline-item.latest::before {
    background: var(--success-green);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
    100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
}

.visit-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #E5E7EB;
}

.visit-number {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: var(--text-sm);
    font-weight: 600;
}

.visit-date {
    color: #6B7280;
    font-weight: 500;
    font-size: var(--text-sm);
}

.visit-vitals {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
    padding: 1rem;
    background: var(--light-gray);
    border-radius: 6px;
}

.vital-item {
    text-align: center;
}

.vital-label {
    font-size: var(--text-xs);
    color: #6B7280;
    font-weight: 500;
}

.vital-value {
    font-size: var(--text-md);
    font-weight: 600;
    color: var(--dark-gray);
}

.visit-content {
    margin-top: 1rem;
    font-size: var(--text-base);
}

.quick-visit-form {
    background: var(--light-gray);
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    border: 2px dashed var(--primary-blue);
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.health-summary-card {
    background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
    border: 1px solid #0EA5E9;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.health-trends {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.trend-item {
    text-align: center;
    padding: 1rem;
    background: white;
    border-radius: 8px;
}

.trend-arrow {
    font-size: var(--text-xl);
    margin-bottom: 0.5rem;
}

.trend-up { color: #DC2626; }
.trend-down { color: #10B981; }
.trend-stable { color: #6B7280; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, var(--white), var(--light-gray));
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card.patients { border-left-color: var(--primary-blue); }
.stat-card.visits { border-left-color: var(--primary-red); }
.stat-card.departments { border-left-color: var(--success-green); }
.stat-card.today { border-left-color: var(--warning-yellow); }

.stat-number {
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--dark-gray);
    line-height: 1.2;
}

.stat-label {
    font-size: var(--text-base);
    color: #6B7280;
    margin-top: 0.5rem;
}

.visit-history {
    background: var(--light-gray);
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}

.visit-item {
    background: var(--white);
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    border-left: 3px solid var(--primary-red);
    font-size: var(--text-base);
}

.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-weight: 500;
    font-size: var(--text-base);
}

.alert-success {
    background: #D1FAE5;
    color: #065F46;
    border: 1px solid #10B981;
}

.alert-warning {
    background: #FEF3C7;
    color: #92400E;
    border: 1px solid #F59E0B;
}

.breadcrumb {
    background: var(--light-gray);
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-size: var(--text-base);
}

.breadcrumb a {
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 500;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.chart-container {
    background: var(--white);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.date-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
}

.export-buttons {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

/* Enhanced search container for department filtering */
.search-container .form-group {
    margin-bottom: 0;
}

.search-container .form-group label {
    font-size: var(--text-sm);
    margin-bottom: 0.3rem;
}

.search-container input,
.search-container select {
    padding: 8px 12px;
    font-size: var(--text-base);
}

/* Filter summary styling */
#patientFilterSummary {
    margin-top: 1rem;
}

#patientFilterSummary .alert {
    margin-bottom: 0;
}

/* Enhanced patient cards with department highlighting */
.patient-card .patient-details [style*="color: var(--primary-blue)"] {
    background: linear-gradient(135deg, #EFF6FF, #DBEAFE);
    padding: 2px 6px;
    border-radius: 4px;
    display: inline-block;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    position: relative;
}

.modal-header {
    text-align: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #E5E7EB;
}

.modal-header h3 {
    color: #DC2626;
    margin: 0;
    font-size: var(--text-xl);
}

.close {
    position: absolute;
    right: 15px;
    top: 15px;
    font-size: var(--text-2xl);
    font-weight: bold;
    cursor: pointer;
    color: #6B7280;
}

.close:hover {
    color: #DC2626;
}

.patient-search-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #E5E7EB;
    border-radius: 8px;
    font-size: var(--text-base);
    margin-bottom: 1rem;
}

.patient-search-input:focus {
    outline: none;
    border-color: #DC2626;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.delete-search-results {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.delete-patient-item {
    background: #FEF2F2;
    border: 1px solid #FECACA;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.delete-patient-item:hover {
    background: #FEE2E2;
    border-color: #FCA5A5;
    transform: translateY(-1px);
}

.delete-patient-name {
    font-weight: 600;
    color: #DC2626;
    margin-bottom: 0.5rem;
    font-size: var(--text-md);
}

.delete-patient-details {
    font-size: var(--text-sm);
    color: #6B7280;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.5rem;
}

.edit-patient-form {
    background: #F0F9FF;
    border: 2px solid #0EA5E9;
    border-radius: 12px;
    padding: 2rem;
    margin: 2rem 0;
    display: none;
}

.edit-patient-form.active {
    display: block;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.edit-form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #0EA5E9;
}

.edit-form-header h3 {
    color: #0EA5E9;
    margin: 0;
}

.btn-edit {
    background: linear-gradient(135deg, #0EA5E9, #0284C7);
    color: white;
    padding: 6px 12px;
    font-size: var(--text-sm);
    border-radius: 6px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-edit:hover {
    background: linear-gradient(135deg, #0284C7, #0369A1);
    transform: translateY(-1px);
}

.edit-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.loading {
    text-align: center;
    padding: 2rem;
    color: var(--primary-blue);
    font-size: var(--text-base);
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary-blue);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Mobile Responsive Typography */
@media (max-width: 768px) {
    :root {
        --text-xs: 11px;
        --text-sm: 12px;
        --text-base: 13px;
        --text-md: 14px;
        --text-lg: 16px;
        --text-xl: 18px;
        --text-2xl: 20px;
        --text-3xl: 24px;
    }
    
    .container {
        padding: 0 0.5rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .nav-tabs button {
        padding: 12px 15px;
        font-size: var(--text-sm);
    }

    .patient-header {
        flex-direction: column;
        gap: 0.5rem;
    }

    .date-filters {
        flex-direction: column;
        align-items: stretch;
    }

    .export-buttons {
        flex-direction: column;
    }

    .search-container > div[style*="display: flex"] {
        flex-direction: column;
        gap: 1rem;
    }
    
    .search-container .form-group {
        width: 100%;
    }
    
    .search-container input,
    .search-container select {
        width: 100%;
    }

    .portal-stats {
        flex-direction: column;
        gap: 1rem;
    }
    
    .visit-timeline {
        margin-left: 1rem;
    }
    
    .timeline-item {
        margin-left: 0.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Additional utility classes */
.text-center { text-align: center; }
.mb-2 { margin-bottom: 1rem; }
.mt-2 { margin-top: 1rem; }
.hidden { display: none !important; }

/* Accessibility improvements */
.nav-tabs button:focus {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
}

.btn:focus {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
}

/* Enhanced report preview styling */
.chart-container .stats-grid {
    margin-bottom: 1rem;
}

.chart-container .alert {
    background: linear-gradient(135deg, #D1FAE5, #A7F3D0);
    border-color: #10B981;
    color: #065F46;
}

/* Active patients highlight */
.patient-card[data-active="true"] {
    border-left-color: var(--success-green);
    background: linear-gradient(135deg, #F0FDF4, #DCFCE7);
}

.patient-card[data-active="true"]:hover {
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.2);
}

/* Department filter dropdown enhancement */
#departmentFilter {
    min-width: 200px;
}

#departmentFilter:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

/* Filter buttons styling */
.search-container .btn {
    padding: 8px 16px;
    font-size: var(--text-base);
    white-space: nowrap;
}

.search-container .btn-secondary {
    background: linear-gradient(135deg, #6B7280, #4B5563);
}

.search-container .btn-secondary:hover {
    background: linear-gradient(135deg, #4B5563, #374151);
}

/* Print styles (for data export previews) */
@media print {
    .nav-tabs,
    .export-buttons,
    .btn {
        display: none;
    }
    
    body {
        background: white;
        color: black;
        font-size: 12pt;
        line-height: 1.4;
    }
    
    .stat-number {
        font-size: 18pt;
    }
    
    .patient-name {
        font-size: 14pt;
    }
    
    .portal-name {
        font-size: 16pt;
    }
}

/* Professional Data Tables */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: var(--text-base);
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.data-table th {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    font-size: var(--text-sm);
    letter-spacing: 0.5px;
}

.data-table td {
    padding: 10px 16px;
    border-bottom: 1px solid #E5E7EB;
    font-size: var(--text-base);
}

.data-table tr:hover {
    background: #F9FAFB;
}

.data-table tr:last-child td {
    border-bottom: none;
}

/* Professional Status Badges */
.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: var(--text-xs);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: #D1FAE5;
    color: #065F46;
}

.status-inactive {
    background: #FEE2E2;
    color: #991B1B;
}

.status-pending {
    background: #FEF3C7;
    color: #92400E;
}

/* Professional Form Sections */
.form-section {
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.form-section-title {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--primary-blue);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #E5E7EB;
}

/* Professional Cards */
.info-card {
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.info-card-title {
    font-size: var(--text-md);
    font-weight: 600;
    color: var(--dark-gray);
    margin-bottom: 0.5rem;
}

.info-card-content {
    font-size: var(--text-base);
    color: #6B7280;
    line-height: 1.6;
}

/* Professional Navigation Breadcrumbs */
.breadcrumb-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: var(--text-sm);
    color: #6B7280;
    margin-bottom: 1rem;
}

.breadcrumb-nav a {
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 500;
}

.breadcrumb-nav a:hover {
    text-decoration: underline;
}

.breadcrumb-separator {
    color: #9CA3AF;
    font-weight: 400;
}

/* Professional Tooltips */
.tooltip {
    position: relative;
    display: inline-block;
    cursor: help;
}

.tooltip .tooltip-text {
    visibility: hidden;
    width: 200px;
    background-color: var(--dark-gray);
    color: white;
    text-align: center;
    border-radius: 6px;
    padding: 8px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -100px;
    font-size: var(--text-sm);
    opacity: 0;
    transition: opacity 0.3s;
}

.tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* Professional Error States */
.error-message {
    background: #FEF2F2;
    border: 1px solid #FECACA;
    color: #991B1B;
    padding: 1rem;
    border-radius: 8px;
    font-size: var(--text-base);
    margin: 1rem 0;
}

.success-message {
    background: #F0FDF4;
    border: 1px solid #BBF7D0;
    color: #166534;
    padding: 1rem;
    border-radius: 8px;
    font-size: var(--text-base);
    margin: 1rem 0;
}

.warning-message {
    background: #FFFBEB;
    border: 1px solid #FDE68A;
    color: #92400E;
    padding: 1rem;
    border-radius: 8px;
    font-size: var(--text-base);
    margin: 1rem 0;
}

.info-message {
    background: #EFF6FF;
    border: 1px solid #BFDBFE;
    color: #1E40AF;
    padding: 1rem;
    border-radius: 8px;
    font-size: var(--text-base);
    margin: 1rem 0;
}

/* Professional Progress Indicators */
.progress-bar {
    background: #E5E7EB;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-fill {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    height: 100%;
    border-radius: 10px;
    transition: width 0.3s ease;
}

.progress-label {
    font-size: var(--text-sm);
    color: #6B7280;
    margin-bottom: 0.25rem;
}

/* Professional Pagination */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin: 2rem 0;
}

.pagination button {
    background: white;
    border: 1px solid #E5E7EB;
    color: var(--dark-gray);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all 0.3s ease;
}

.pagination button:hover {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
}

.pagination button.active {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
}

.pagination button:disabled {
    background: #F9FAFB;
    color: #9CA3AF;
    cursor: not-allowed;
}

/* Professional Dropdowns */
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 160px;
    box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 1;
    border: 1px solid #E5E7EB;
    overflow: hidden;
}

.dropdown-content a {
    color: var(--dark-gray);
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-size: var(--text-base);
    transition: background-color 0.3s ease;
}

.dropdown-content a:hover {
    background-color: #F9FAFB;
}

.dropdown:hover .dropdown-content {
    display: block;
}

/* Professional Tabs Enhancement */
.tab-indicator {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    transition: all 0.3s ease;
    border-radius: 3px 3px 0 0;
}

/* Professional Loading States */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton-text {
    height: 16px;
    margin-bottom: 8px;
}

.skeleton-title {
    height: 24px;
    width: 60%;
    margin-bottom: 12px;
}

/* Professional Search Enhancement */
.search-input-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9CA3AF;
    font-size: var(--text-base);
}

.search-input-container input {
    padding-left: 40px;
}

.search-clear {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #9CA3AF;
    cursor: pointer;
    font-size: var(--text-base);
}

/* Professional Accordion */
.accordion {
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.accordion-header {
    background: #F9FAFB;
    padding: 1rem 1.5rem;
    cursor: pointer;
    border-bottom: 1px solid #E5E7EB;
    font-weight: 600;
    font-size: var(--text-base);
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.3s ease;
}

.accordion-header:hover {
    background: #F3F4F6;
}

.accordion-content {
    padding: 1.5rem;
    font-size: var(--text-base);
    line-height: 1.6;
    display: none;
}

.accordion-content.active {
    display: block;
}

.accordion-icon {
    transition: transform 0.3s ease;
    font-size: var(--text-sm);
}

.accordion-header.active .accordion-icon {
    transform: rotate(180deg);
}

/* Professional Metrics Cards */
.metric-card {
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
}

.metric-value {
    font-size: var(--text-3xl);
    font-weight: 700;
    color: var(--dark-gray);
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: var(--text-base);
    color: #6B7280;
    margin-bottom: 0.5rem;
}

.metric-change {
    font-size: var(--text-sm);
    font-weight: 600;
}

.metric-change.positive {
    color: #10B981;
}

.metric-change.negative {
    color: #DC2626;
}

.metric-change.neutral {
    color: #6B7280;
}

/* Professional Calendar */
.calendar {
    background: white;
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    overflow: hidden;
}

.calendar-header {
    background: linear-gradient(135deg, var(--primary-red), var(--primary-blue));
    color: white;
    padding: 1rem;
    text-align: center;
    font-size: var(--text-lg);
    font-weight: 600;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #E5E7EB;
}

.calendar-day {
    background: white;
    padding: 0.75rem;
    text-align: center;
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all 0.3s ease;
}

.calendar-day:hover {
    background: #F3F4F6;
}

.calendar-day.today {
    background: var(--primary-blue);
    color: white;
}

.calendar-day.selected {
    background: var(--primary-red);
    color: white;
}

/* Enhanced Mobile Responsiveness */
@media (max-width: 480px) {
    :root {
        --text-xs: 10px;
        --text-sm: 11px;
        --text-base: 12px;
        --text-md: 13px;
        --text-lg: 14px;
        --text-xl: 16px;
        --text-2xl: 18px;
        --text-3xl: 20px;
    }
    
    .modal-content {
        margin: 5% auto;
        width: 95%;
        padding: 1rem;
    }
    
    .data-table {
        font-size: var(--text-sm);
    }
    
    .data-table th,
    .data-table td {
        padding: 8px 12px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .calendar-grid {
        font-size: var(--text-xs);
    }
    
    .accordion-header {
        padding: 0.75rem 1rem;
    }
    
    .accordion-content {
        padding: 1rem;
    }
}
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">UAC</div>
        <div class="company-name">UAC FOODS Clinic Management</div>
        <h1>Clinic Management System</h1>
    </header>

    <nav class="nav-tabs">
        <ul>
            <li><button onclick="showTab('dashboard')" class="tab-btn active">Dashboard</button></li>
            <li><button onclick="showTab('newPatient')" class="tab-btn">New Patient</button></li>
            <li><button onclick="showTab('allPatients')" class="tab-btn">All Patients</button></li>
            <li><button onclick="showTab('search')" class="tab-btn">Search</button></li>
            <li><button onclick="showTab('reports')" class="tab-btn">Reports</button></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <h2>Dashboard</h2>
            
            <div class="date-filters">
    <div class="form-group">
        <label for="yearFilter">Filter by Year:</label>
        <select id="yearFilter" onchange="filterData()">
            <option value="">All Years</option>
        </select>
    </div>
    <div class="form-group">
        <label for="monthFilter">Filter by Month:</label>
        <select id="monthFilter" onchange="filterData()">
            <option value="">All Months</option>
            <option value="1">January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="specificDate">Specific Date:</label>
        <input type="date" id="specificDate" onchange="filterBySpecificDate()">
    </div>
    <button onclick="resetFilters()" class="btn btn-secondary">Reset Filters</button>
</div>

            <div class="stats-grid">
                <div class="stat-card patients">
                    <div class="stat-number" id="totalPatients">0</div>
                    <div class="stat-label">Total Patients</div>
                </div>
                <div class="stat-card visits">
                    <div class="stat-number" id="totalVisits">0</div>
                    <div class="stat-label">Total Visits</div>
                </div>
                <div class="stat-card departments">
                    <div class="stat-number" id="totalDepartments">0</div>
                    <div class="stat-label">Departments</div>
                </div>
                <div class="stat-card today">
                    <div class="stat-number" id="visitsToday">0</div>
                    <div class="stat-label">Visits Today</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>Visits by Department</h3>
                <div id="departmentChart" style="height: 400px;"></div>
            </div>

            <div class="chart-container">
                <h3>Monthly Visit Trends</h3>
                <div id="monthlyChart" style="height: 400px;"></div>
            </div>

            <div>
                <h3>Recent Visits</h3>
                <div id="recentVisits"></div>
            </div>
        </div>

        <!-- New Patient Tab -->
        <div id="newPatient" class="tab-content">
            <h2>Register New Patient</h2>
            
            <div class="search-container">
                <h3>Quick Check - Patient Already Exists?</h3>
                <input type="text" id="quickSearch" placeholder="Type patient name to check..." oninput="quickSearchPatient()" aria-describedby="quickSearchHelp">
                <small id="quickSearchHelp">Type at least 2 characters to search existing patients</small>
                <div id="quickSearchResults"></div>
            </div>

            <form id="patientForm" novalidate>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="patientName">Full Name *</label>
                        <input type="text" id="patientName" required aria-describedby="nameHelp">
                        <small id="nameHelp">Enter patient's full name</small>
                    </div>
                    <div class="form-group">
                        <label for="department">Department *</label>
                        <select id="department" required>
                            <option value="">Select Department</option>
                            <option value="Production">Production</option>
                            <option value="Quality Control">Quality Control</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Administration">Administration</option>
                            <option value="Security">Security</option>
                            <option value="Transport">Transport</option>
                            <option value="Finance">Finance</option>
                            <option value="HR">Human Resources</option>
                            <option value="Outsource">Outsource Staff</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="role">Role/Position *</label>
                        <input type="text" id="role" required>
                    </div>
                    <div class="form-group">
                        <label for="employeeId">Employee ID</label>
                        <input type="text" id="employeeId">
                    </div>
                    <div class="form-group">
                        <label for="bloodPressure">Blood Pressure</label>
                        <input type="text" id="bloodPressure" placeholder="e.g., 120/80">
                    </div>
                    <div class="form-group">
                        <label for="weight">Weight (kg)</label>
                        <input type="number" id="weight" step="0.1" min="0" max="300">
                    </div>
                    <div class="form-group">
                        <label for="height">Height (cm)</label>
                        <input type="number" id="height" step="0.1" min="0" max="250">
                    </div>
                    <div class="form-group">
                        <label for="age">Age</label>
                        <input type="number" id="age" min="0" max="120">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ailment">Nature of Ailment *</label>
                    <textarea id="ailment" required rows="4" aria-describedby="ailmentHelp"></textarea>
                    <small id="ailmentHelp">Describe the medical issue or reason for visit</small>
                </div>
                
                <div class="form-group">
                    <label for="notes">Additional Notes</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                
                <button type="submit" class="btn">Register Patient & Record Visit</button>
            </form>
        </div>

        <!-- All Patients Tab -->
        <div id="allPatients" class="tab-content">
            <nav id="breadcrumb" class="breadcrumb hidden" aria-label="Breadcrumb">
                <a href="#" onclick="showAllPatients()">← Back to All Patients</a>
            </nav>

            <div id="patientsView">
                <h2>All Patients</h2>
                <div class="search-container">
                    <label for="patientSearch" class="sr-only">Search patients</label>
                    <input type="text" id="patientSearch" placeholder="Search patients by name..." oninput="searchAllPatients()">
                </div>
                <div id="patientsList" role="list"></div>
            </div>

            <div id="individualPatientView" class="hidden">
                <div id="patientDashboard"></div>
            </div>
        </div>


        <!-- Search Tab -->
        <div id="search" class="tab-content">
            <h2>Search Patients</h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="searchName">Search by Name</label>
                    <input type="text" id="searchName" placeholder="Enter patient name..." oninput="performSearch()">
                </div>
                <div class="form-group">
                    <label for="searchDepartment">Search by Department</label>
                    <select id="searchDepartment" onchange="performSearch()">
                        <option value="">All Departments</option>
                        <option value="Production">Production</option>
                        <option value="Quality Control">Quality Control</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Administration">Administration</option>
                        <option value="Security">Security</option>
                        <option value="Transport">Transport</option>
                        <option value="Finance">Finance</option>
                        <option value="HR">Human Resources</option>
                        <option value="Outsource">Outsource Staff</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="searchRole">Search by Role</label>
                    <input type="text" id="searchRole" placeholder="Enter role/position..." oninput="performSearch()">
                </div>
                <div class="form-group">
                    <label for="searchEmployeeId">Search by Employee ID</label>
                    <input type="text" id="searchEmployeeId" placeholder="Enter employee ID..." oninput="performSearch()">
                </div>
            </div>
            
            <button onclick="clearSearch()" class="btn btn-secondary">Clear Search</button>
            
            <div id="searchResults" role="region" aria-live="polite"></div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <h2>Reports & Data Export</h2>
            
            <div class="date-filters">
                <div class="form-group">
                    <label for="reportFromDate">From Date:</label>
                    <input type="date" id="reportFromDate">
                </div>
                <div class="form-group">
                    <label for="reportToDate">To Date:</label>
                    <input type="date" id="reportToDate">
                </div>
                <div class="form-group">
                    <label for="reportDepartment">Department:</label>
                    <select id="reportDepartment">
                        <option value="">All Departments</option>
                        <option value="Production">Production</option>
                        <option value="Quality Control">Quality Control</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Administration">Administration</option>
                        <option value="Security">Security</option>
                        <option value="Transport">Transport</option>
                        <option value="Finance">Finance</option>
                        <option value="HR">Human Resources</option>
                        <option value="Outsource">Outsource Staff</option>
                    </select>
                </div>
            </div>

            <div class="export-buttons">
                <button onclick="exportToExcel()" class="btn btn-success">Export Data to Excel</button>
            </div>

            <div id="reportPreview" role="region" aria-live="polite"></div>
        </div>
    </div>

    <!-- Delete Patient Modal -->
<div id="deletePatientModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeDeleteModal()">&times;</span>
        <div class="modal-header">
            <h3>🗑️ Delete Patient Record</h3>
            <p style="color: #DC2626; margin: 0.5rem 0 0 0; font-weight: 500;">⚠️ This action cannot be undone!</p>
        </div>
        
        <div class="form-group">
            <label for="deleteSearchInput">Search Patient to Delete:</label>
            <input type="text" 
                   id="deleteSearchInput" 
                   class="patient-search-input"
                   placeholder="Type patient name to search..." 
                   oninput="searchPatientsForDelete()"
                   autocomplete="off">
        </div>
        
        <div id="deleteSearchResults" class="delete-search-results"></div>
        
        <div style="text-align: center; margin-top: 1rem;">
            <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

    <script>
        // Global Variables
let patients = JSON.parse(localStorage.getItem('patients')) || [];
let visits = JSON.parse(localStorage.getItem('visits')) || [];
let currentPatient = null;

// Initialize App
document.addEventListener('DOMContentLoaded', function() {
    updateDashboard();
    populateYearFilter();
    displayAllPatients();
    
    // Add welcome message if there are patients
    setTimeout(() => {
        if (patients.length > 0) {
            showAlert(`Welcome to UAC FOODS Clinic Management System! You have ${patients.length} registered patients and ${visits.length} total visits.`, 'success');
        }
    }, 1000);
});

// Tab Management
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');

    // Refresh data when switching to certain tabs
    if (tabName === 'dashboard') {
        updateDashboard();
    } else if (tabName === 'allPatients') {
        showAllPatients();
    }
}

// Patient Registration
document.getElementById('patientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('patientName').value,
        department: document.getElementById('department').value,
        role: document.getElementById('role').value,
        employeeId: document.getElementById('employeeId').value,
        bloodPressure: document.getElementById('bloodPressure').value,
        weight: document.getElementById('weight').value,
        height: document.getElementById('height').value,
        age: document.getElementById('age').value,
        ailment: document.getElementById('ailment').value,
        notes: document.getElementById('notes').value
    };

    // Check if patient already exists
    const existingPatient = patients.find(p => 
        p.name.toLowerCase() === formData.name.toLowerCase() ||
        (formData.employeeId && p.employeeId === formData.employeeId)
    );

    if (existingPatient) {
        if (confirm('Patient already exists. Do you want to add a new visit for this patient?')) {
            addNewVisit(existingPatient, formData.ailment, formData.notes);
        }
        return;
    }

    // Create new patient
    const newPatient = {
        id: generateId(),
        name: formData.name,
        department: formData.department,
        role: formData.role,
        employeeId: formData.employeeId,
        bloodPressure: formData.bloodPressure,
        weight: formData.weight,
        height: formData.height,
        age: formData.age,
        registrationDate: new Date().toISOString(),
        visits: []
    };

    // Add first visit
    const firstVisit = {
        id: generateId(),
        patientId: newPatient.id,
        date: new Date().toISOString(),
        ailment: formData.ailment,
        notes: formData.notes,
        bloodPressure: formData.bloodPressure,
        weight: formData.weight,
        height: formData.height
    };

    newPatient.visits.push(firstVisit);
    patients.push(newPatient);
    visits.push(firstVisit);

    saveData();
    showAlert('Patient registered successfully!', 'success');
    document.getElementById('patientForm').reset();
    updateDashboard();
});

// Add new visit for existing patient
function addNewVisit(patient, ailment, notes) {
    const newVisit = {
        id: generateId(),
        patientId: patient.id,
        date: new Date().toISOString(),
        ailment: ailment,
        notes: notes,
        bloodPressure: document.getElementById('bloodPressure').value,
        weight: document.getElementById('weight').value,
        height: document.getElementById('height').value
    };

    patient.visits.push(newVisit);
    visits.push(newVisit);

    saveData();
    showAlert('New visit recorded successfully!', 'success');
    document.getElementById('patientForm').reset();
    updateDashboard();
}


function initializeDepartmentFilter() {
    const allPatientsTab = document.getElementById('allPatients');
    
    // Add department filter interface
    const departmentFilterHTML = `
        <div id="patientsView">
            <h2>All Patients</h2>
            
            <div class="search-container">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="patientSearch">Search patients:</label>
                        <input type="text" id="patientSearch" placeholder="Search by name..." oninput="searchAllPatients()">
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="departmentFilter">Filter by Department:</label>
                        <select id="departmentFilter" onchange="filterPatientsByDepartment()">
                            <option value="">All Departments</option>
                            <option value="Production">Production</option>
                            <option value="Quality Control">Quality Control</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Administration">Administration</option>
                            <option value="Security">Security</option>
                            <option value="Transport">Transport</option>
                            <option value="Finance">Finance</option>
                            <option value="HR">Human Resources</option>
                            <option value="Outsource">Outsource Staff</option>
                        </select>
                    </div>
                    
                    <button onclick="showDeletePatientModal()" class="btn btn-danger">🗑️ Delete Patient</button>
                    <button onclick="resetPatientFilters()" class="btn btn-secondary">Reset</button>
                </div>
                
                <div id="patientFilterSummary" style="margin-top: 1rem;"></div>
            </div>
            
            <div id="patientsList" role="list"></div>
        </div>`;
    
    // Update the existing patientsView with the enhanced version
    const existingPatientsView = allPatientsTab.querySelector('#patientsView');
    if (existingPatientsView) {
        existingPatientsView.outerHTML = departmentFilterHTML;
    }
}

// ADD the department filtering function:

function filterPatientsByDepartment() {
    const selectedDepartment = document.getElementById('departmentFilter').value;
    const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
    
    let filteredPatients = patients;
    
    // Filter by department
    if (selectedDepartment) {
        filteredPatients = filteredPatients.filter(patient => 
            patient.department === selectedDepartment
        );
    }
    
    // Filter by search term
    if (searchTerm) {
        filteredPatients = filteredPatients.filter(patient => 
            patient.name.toLowerCase().includes(searchTerm)
        );
    }
    
    displayFilteredPatientList(filteredPatients, selectedDepartment, searchTerm);
}

function displayFilteredPatientList(filteredPatients, department, searchTerm) {
    const patientsList = document.getElementById('patientsList');
    const summaryDiv = document.getElementById('patientFilterSummary');
    
    // Update summary
    const departmentCounts = getDepartmentCounts(filteredPatients);
    summaryDiv.innerHTML = `
        <div class="alert alert-success">
            <strong>Filter Results:</strong> 
            ${filteredPatients.length} patients found
            ${department ? ` in ${department}` : ''}
            ${searchTerm ? ` matching "${searchTerm}"` : ''}
            <br>
            <small>Department breakdown: ${Object.entries(departmentCounts).map(([dept, count]) => `${dept}: ${count}`).join(', ')}</small>
        </div>
    `;
    
    if (filteredPatients.length === 0) {
        patientsList.innerHTML = '<div class="alert alert-warning">No patients found matching your criteria.</div>';
        return;
    }

    // Sort patients by department, then by name
    const sortedPatients = [...filteredPatients].sort((a, b) => {
        if (a.department !== b.department) {
            return a.department.localeCompare(b.department);
        }
        return a.name.localeCompare(b.name);
    });

    const patientsHtml = sortedPatients.map(patient => {
        const stats = getPatientStats(patient.id);
        const lastVisit = patient.visits.length > 0 ? patient.visits[patient.visits.length - 1] : null;
        
        return `
            <div class="patient-card" onclick="showPatientDashboard('${patient.id}')">
                <div class="patient-header">
                    <div class="patient-name">${patient.name}</div>
                    <div class="visit-count">${patient.visits.length} visit${patient.visits.length !== 1 ? 's' : ''}</div>
                </div>
                <div class="patient-details">
                    <div><strong>Dept:</strong> <span style="color: var(--primary-blue); font-weight: 600;">${patient.department}</span></div>
                    <div><strong>Role:</strong> ${patient.role}</div>
                    <div><strong>ID:</strong> ${patient.employeeId || 'N/A'}</div>
                    <div><strong>Age:</strong> ${patient.age || 'N/A'}</div>
                    <div><strong>Last Visit:</strong> ${lastVisit ? formatDate(lastVisit.date) : 'None'}</div>
                    <div><strong>This Month:</strong> ${stats?.thisMonth || 0} visits</div>
                </div>
            </div>
        `;
    }).join('');

    patientsList.innerHTML = patientsHtml;
}

function getDepartmentCounts(patients) {
    const counts = {};
    patients.forEach(patient => {
        counts[patient.department] = (counts[patient.department] || 0) + 1;
    });
    return counts;
}

function showActivePatients() {
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const activePatients = patients.filter(patient => {
        if (patient.visits.length === 0) return false;
        const lastVisit = new Date(patient.visits[patient.visits.length - 1].date);
        return lastVisit >= thirtyDaysAgo;
    });
    
    displayFilteredPatientList(activePatients, '', '');
    document.getElementById('patientFilterSummary').innerHTML = `
        <div class="alert alert-success">
            <strong>Active Patients:</strong> ${activePatients.length} patients with visits in the last 30 days
        </div>
    `;
}

function resetPatientFilters() {
    document.getElementById('departmentFilter').value = '';
    document.getElementById('patientSearch').value = '';
    document.getElementById('patientFilterSummary').innerHTML = '';
    displayAllPatients();
}


// Quick search functionality
function quickSearchPatient() {
    const searchTerm = document.getElementById('quickSearch').value.toLowerCase();
    const resultsDiv = document.getElementById('quickSearchResults');
    
    if (searchTerm.length < 2) {
        resultsDiv.innerHTML = '';
        return;
    }

    const matches = patients.filter(patient => 
        patient.name.toLowerCase().includes(searchTerm)
    );

    if (matches.length > 0) {
        resultsDiv.innerHTML = `
            <div class="alert alert-warning">
                <strong>Found ${matches.length} existing patient(s):</strong><br>
                ${matches.map(p => `${p.name} (${p.department})`).join(', ')}
                <br><button onclick="fillPatientDetails('${matches[0].id}')" class="btn" style="margin-top: 10px;">Fill Patient Details</button>
            </div>
        `;
    } else {
        resultsDiv.innerHTML = '<div class="alert alert-success">No existing patient found. You can proceed with registration.</div>';
    }
}

// Fill patient details for new visit
function fillPatientDetails(patientId) {
    const patient = patients.find(p => p.id === patientId);
    if (patient) {
        document.getElementById('patientName').value = patient.name;
        document.getElementById('department').value = patient.department;
        document.getElementById('role').value = patient.role;
        document.getElementById('employeeId').value = patient.employeeId || '';
        document.getElementById('bloodPressure').value = patient.bloodPressure || '';
        document.getElementById('weight').value = patient.weight || '';
        document.getElementById('height').value = patient.height || '';
        document.getElementById('age').value = patient.age || '';
        
        showAlert('Patient details filled. Please add the new visit information.', 'success');
    }
}

// Display all patients
function displayAllPatients() {
    const patientsList = document.getElementById('patientsList');
    
    if (patients.length === 0) {
        patientsList.innerHTML = '<div class="alert alert-warning">No patients registered yet.</div>';
        return;
    }

    // Sort patients by last visit date (most recent first)
    const sortedPatients = [...patients].sort((a, b) => {
        const aLastVisit = a.visits.length > 0 ? new Date(a.visits[a.visits.length - 1].date) : new Date(0);
        const bLastVisit = b.visits.length > 0 ? new Date(b.visits[b.visits.length - 1].date) : new Date(0);
        return bLastVisit - aLastVisit;
    });

    const patientsHtml = sortedPatients.map(patient => {
        const stats = getPatientStats(patient.id);
        const lastVisit = patient.visits.length > 0 ? patient.visits[patient.visits.length - 1] : null;
        
        return `
            <div class="patient-card" onclick="showPatientDashboard('${patient.id}')">
                <div class="patient-header">
                    <div class="patient-name">${patient.name}</div>
                    <div class="visit-count">${patient.visits.length} visit${patient.visits.length !== 1 ? 's' : ''}</div>
                </div>
                <div class="patient-details">
                    <div><strong>Dept:</strong> ${patient.department}</div>
                    <div><strong>Role:</strong> ${patient.role}</div>
                    <div><strong>ID:</strong> ${patient.employeeId || 'N/A'}</div>
                    <div><strong>Age:</strong> ${patient.age || 'N/A'}</div>
                    <div><strong>Last Visit:</strong> ${lastVisit ? formatDate(lastVisit.date) : 'None'}</div>
                    <div><strong>This Month:</strong> ${stats?.thisMonth || 0} visits</div>
                </div>
            </div>
        `;
    }).join('');

    patientsList.innerHTML = patientsHtml;
}

// REPLACE THIS ENTIRE FUNCTION (around line 350-400):

function showPatientDashboard(patientId) {
    console.log('Opening dashboard for patient:', patientId); // Debug log
    
    const patient = patients.find(p => p.id === patientId);
    if (!patient) {
        console.error('Patient not found:', patientId);
        showAlert('Patient not found!', 'warning');
        return;
    }

    console.log('Patient found:', patient); // Debug log
    currentPatient = patient;
    
    // Show the individual patient view and hide the patients list
    const patientsView = document.getElementById('patientsView');
    const individualView = document.getElementById('individualPatientView');
    const breadcrumb = document.getElementById('breadcrumb');
    
    if (patientsView) patientsView.style.display = 'none';
    if (individualView) {
        individualView.style.display = 'block';
        individualView.classList.remove('hidden');
    }
    if (breadcrumb) {
        breadcrumb.style.display = 'block';
        breadcrumb.classList.remove('hidden');
    }

    // Calculate patient statistics
    const stats = calculatePatientStats(patient);
    const healthTrends = analyzeHealthTrends(patient.visits);
    
    // Get patient initials for avatar
    const initials = patient.name.split(' ').map(name => name[0]).join('').toUpperCase();

    const dashboardHtml = `
        <div class="patient-portal-header">
            <div class="portal-avatar">${initials}</div>
            <div class="portal-basic-info">
                <div class="portal-name">${patient.name}</div>
                <div class="portal-subtitle">${patient.department} • ${patient.role}</div>
                <div class="portal-stats">
                    <div class="portal-stat">
                        <div class="portal-stat-number">${patient.visits.length}</div>
                        <div class="portal-stat-label">Total Visits</div>
                    </div>
                    <div class="portal-stat">
                        <div class="portal-stat-number">${stats.thisMonth}</div>
                        <div class="portal-stat-label">This Month</div>
                    </div>
                    <div class="portal-stat">
                        <div class="portal-stat-number">${stats.daysSinceLastVisit}</div>
                        <div class="portal-stat-label">Days Since Last Visit</div>
                    </div>
                </div>
<div style="text-align: center; margin-top: 1rem;">
    <button onclick="toggleEditPatientForm('${patient.id}')" class="btn-edit">
        ✏️ Edit Patient Information
    </button>
</div>
            </div>
        </div>

        ${generateHealthSummary(patient, healthTrends)}
        ${generateEditPatientForm(patient)}

        <div class="quick-visit-form">
            <h3>🏥 Record New Visit</h3>
            <form id="quickVisitForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Blood Pressure</label>
                        <input type="text" id="quickBP" placeholder="e.g., 120/80">
                    </div>
                    <div class="form-group">
                        <label>Weight (kg)</label>
                        <input type="number" id="quickWeight" step="0.1" placeholder="${getLastVital(patient, 'weight')}">
                    </div>
                    <div class="form-group">
                        <label>Temperature (°C)</label>
                        <input type="number" id="quickTemp" step="0.1" placeholder="36.5">
                    </div>
                    <div class="form-group">
                        <label>Heart Rate (bpm)</label>
                        <input type="number" id="quickHR" placeholder="72">
                    </div>
                </div>
                <div class="form-group">
                    <label>Nature of Ailment/Complaint *</label>
                    <textarea id="quickAilment" required rows="3" placeholder="Describe the reason for this visit..."></textarea>
                </div>
                <div class="form-group">
                    <label>Additional Notes/Questions</label>
                    <textarea id="quickNotes" rows="2" placeholder="Any additional information or questions from doctor..."></textarea>
                </div>
                <button type="submit" class="btn btn-success">📝 Record Visit</button>
            </form>
        </div>

        <div class="visit-timeline">
            <h3>📋 Medical History Timeline</h3>
            ${generateVisitTimeline(patient)}
        </div>
    `;

    const dashboardElement = document.getElementById('patientDashboard');
    if (dashboardElement) {
        dashboardElement.innerHTML = dashboardHtml;
        console.log('Dashboard HTML set successfully'); // Debug log
    } else {
        console.error('patientDashboard element not found!');
        return;
    }

    // Add event listener for quick visit form with a small delay
    setTimeout(() => {
        const quickVisitForm = document.getElementById('quickVisitForm');
        if (quickVisitForm) {
            quickVisitForm.addEventListener('submit', function(e) {
                e.preventDefault();
                recordQuickVisit(patient);
            });
            console.log('Quick visit form event listener added'); // Debug log
        } else {
            console.error('quickVisitForm not found!');
        }
    }, 100);
}


function generateEditPatientForm(patient) {
    return `
        <div id="editPatientForm_${patient.id}" class="edit-patient-form">
            <div class="edit-form-header">
                <h3>✏️ Edit Patient Information</h3>
                <button onclick="cancelEditPatient('${patient.id}')" class="btn btn-secondary" style="padding: 6px 12px; font-size: 14px;">Cancel</button>
            </div>
            
            <form id="editForm_${patient.id}" onsubmit="savePatientEdit(event, '${patient.id}')">
                <div class="edit-form-grid">
                    <div class="form-group">
                        <label for="editName_${patient.id}">Full Name *</label>
                        <input type="text" id="editName_${patient.id}" value="${patient.name}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="editAge_${patient.id}">Age</label>
                        <input type="number" id="editAge_${patient.id}" value="${patient.age || ''}" min="0" max="120">
                    </div>
                    
                    <div class="form-group">
                        <label for="editDepartment_${patient.id}">Department *</label>
                        <select id="editDepartment_${patient.id}" required>
                            <option value="Production" ${patient.department === 'Production' ? 'selected' : ''}>Production</option>
                            <option value="Quality Control" ${patient.department === 'Quality Control' ? 'selected' : ''}>Quality Control</option>
                            <option value="Maintenance" ${patient.department === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                            <option value="Administration" ${patient.department === 'Administration' ? 'selected' : ''}>Administration</option>
                            <option value="Security" ${patient.department === 'Security' ? 'selected' : ''}>Security</option>
                            <option value="Transport" ${patient.department === 'Transport' ? 'selected' : ''}>Transport</option>
                            <option value="Finance" ${patient.department === 'Finance' ? 'selected' : ''}>Finance</option>
                            <option value="HR" ${patient.department === 'HR' ? 'selected' : ''}>Human Resources</option>
                            <option value="Outsource" ${patient.department === 'Outsource' ? 'selected' : ''}>Outsource Staff</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="editRole_${patient.id}">Role/Position *</label>
                        <input type="text" id="editRole_${patient.id}" value="${patient.role}" required>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button type="submit" class="btn btn-success">💾 Save Changes</button>
                    <button type="button" onclick="cancelEditPatient('${patient.id}')" class="btn btn-secondary">Cancel</button>
                </div>
            </form>
        </div>
    `;
}

function toggleEditPatientForm(patientId) {
    const editForm = document.getElementById(`editPatientForm_${patientId}`);
    if (editForm.classList.contains('active')) {
        editForm.classList.remove('active');
    } else {
        editForm.classList.add('active');
        // Focus on the name field
        setTimeout(() => {
            document.getElementById(`editName_${patientId}`).focus();
        }, 300);
    }
}

function cancelEditPatient(patientId) {
    const editForm = document.getElementById(`editPatientForm_${patientId}`);
    editForm.classList.remove('active');
}

function savePatientEdit(event, patientId) {
    event.preventDefault();
    
    const patient = patients.find(p => p.id === patientId);
    if (!patient) {
        showAlert('Patient not found!', 'warning');
        return;
    }
    
    // Get new values
    const newName = document.getElementById(`editName_${patientId}`).value.trim();
    const newAge = document.getElementById(`editAge_${patientId}`).value;
    const newDepartment = document.getElementById(`editDepartment_${patientId}`).value;
    const newRole = document.getElementById(`editRole_${patientId}`).value.trim();
    
    // Validation
    if (!newName || newName.length < 2) {
        showAlert('Patient name must be at least 2 characters long!', 'warning');
        return;
    }
    
    if (!newDepartment) {
        showAlert('Department is required!', 'warning');
        return;
    }
    
    if (!newRole || newRole.length < 2) {
        showAlert('Role must be at least 2 characters long!', 'warning');
        return;
    }
    
    // Check if name changed and if new name already exists
    if (newName.toLowerCase() !== patient.name.toLowerCase()) {
        const existingPatient = patients.find(p => 
            p.id !== patientId && 
            p.name.toLowerCase() === newName.toLowerCase()
        );
        
        if (existingPatient) {
            showAlert('A patient with this name already exists!', 'warning');
            return;
        }
    }
    
    // Show what's being changed
    const changes = [];
    if (patient.name !== newName) changes.push(`Name: "${patient.name}" → "${newName}"`);
    if (patient.age !== newAge) changes.push(`Age: "${patient.age || 'Not set'}" → "${newAge || 'Not set'}"`);
    if (patient.department !== newDepartment) changes.push(`Department: "${patient.department}" → "${newDepartment}"`);
    if (patient.role !== newRole) changes.push(`Role: "${patient.role}" → "${newRole}"`);
    
    if (changes.length === 0) {
        showAlert('No changes detected!', 'warning');
        return;
    }
    
    const confirmMessage = `Confirm the following changes for ${patient.name}:\n\n${changes.join('\n')}\n\nSave these changes?`;
    
    if (confirm(confirmMessage)) {
        // Update patient information
        patient.name = newName;
        patient.age = newAge;
        patient.department = newDepartment;
        patient.role = newRole;
        
        // Save to database
        saveData();
        
        showAlert(`✅ Patient information updated successfully!`, 'success');
        
        // Hide edit form and refresh the dashboard
        cancelEditPatient(patientId);
        setTimeout(() => {
            showPatientDashboard(patientId);
            updateDashboard();
        }, 500);
    }
}

function deletePatient(patientId) {
    const patient = patients.find(p => p.id === patientId);
    if (!patient) {
        showAlert('Patient not found!', 'warning');
        return;
    }
    
    const confirmMessage = `⚠️ WARNING: This will permanently delete all records for ${patient.name}\n\n` +
                          `This includes:\n` +
                          `• Patient information\n` +
                          `• All ${patient.visits.length} visit records\n` +
                          `• Medical history\n\n` +
                          `This action CANNOT be undone!\n\n` +
                          `Type "DELETE" to confirm:`;
    
    const confirmation = prompt(confirmMessage);
    
    if (confirmation === 'DELETE') {
        // Remove all visits for this patient
        visits = visits.filter(v => v.patientId !== patientId);
        
        // Remove the patient
        patients = patients.filter(p => p.id !== patientId);
        
        // Save data
        saveData();
        
        // Update dashboard and show all patients
        updateDashboard();
        showAllPatients();
        
        showAlert(`✅ Patient record for ${patient.name} has been permanently deleted.`, 'success');
    } else if (confirmation !== null) {
        showAlert('❌ Deletion cancelled. You must type "DELETE" exactly to confirm.', 'warning');
    }
}


// STEP 2: ADD these helper functions (place them after the showPatientDashboard function):

function calculatePatientStats(patient) {
    const now = new Date();
    const visits = patient.visits || [];
    
    // Calculate visits this month
    const thisMonth = visits.filter(v => {
        const visitDate = new Date(v.date);
        return visitDate.getMonth() === now.getMonth() && 
               visitDate.getFullYear() === now.getFullYear();
    }).length;
    
    // Calculate days since last visit
    let daysSinceLastVisit = 'N/A';
    if (visits.length > 0) {
        const lastVisit = new Date(visits[visits.length - 1].date);
        const diffTime = Math.abs(now - lastVisit);
        daysSinceLastVisit = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }
    
    return {
        thisMonth,
        daysSinceLastVisit,
        totalVisits: visits.length
    };
}

function generateHealthSummary(patient, trends) {
    const lastVisit = patient.visits && patient.visits.length > 0 ? patient.visits[patient.visits.length - 1] : null;
    
    return `
        <div class="health-summary-card">
            <h3>📊 Health Summary</h3>
            <div class="patient-details" style="margin-bottom: 1rem;">
                <div><strong>Employee ID:</strong> ${patient.employeeId || 'Not provided'}</div>
                <div><strong>Age:</strong> ${patient.age || 'Not provided'}</div>
                <div><strong>Last Visit:</strong> ${lastVisit ? formatDateTime(lastVisit.date) : 'No visits yet'}</div>
                <div><strong>Registration:</strong> ${formatDate(patient.registrationDate)}</div>
            </div>
            
            <div class="health-trends">
                <div class="trend-item">
                    <div class="trend-arrow trend-${trends.bloodPressure}">
                        ${trends.bloodPressure === 'increasing' ? '↗️' : trends.bloodPressure === 'decreasing' ? '↘️' : '➡️'}
                    </div>
                    <div><strong>Blood Pressure</strong></div>
                    <div>${trends.bloodPressure}</div>
                </div>
                <div class="trend-item">
                    <div class="trend-arrow trend-${trends.weight}">
                        ${trends.weight === 'increasing' ? '↗️' : trends.weight === 'decreasing' ? '↘️' : '➡️'}
                    </div>
                    <div><strong>Weight</strong></div>
                    <div>${trends.weight}</div>
                </div>
                <div class="trend-item">
                    <div class="trend-arrow">🔄</div>
                    <div><strong>Visit Frequency</strong></div>
                    <div>${calculateVisitFrequency(patient.visits || [])}</div>
                </div>
            </div>
        </div>
    `;
}

function generateVisitTimeline(patient) {
    const visits = patient.visits || [];
    
    if (visits.length === 0) {
        return '<div class="alert alert-warning">No visits recorded yet. Record the first visit using the form above!</div>';
    }
    
    const sortedVisits = [...visits].sort((a, b) => new Date(b.date) - new Date(a.date));
    
    return sortedVisits.map((visit, index) => {
        const isLatest = index === 0;
        const visitNumber = visits.length - index;
        
        return `
            <div class="timeline-item ${isLatest ? 'latest' : ''}">
                <div class="visit-header">
                    <span class="visit-number">Visit #${visitNumber}</span>
                    <span class="visit-date">${formatDateTime(visit.date)}</span>
                </div>
                
                ${generateVitalsDisplay(visit)}
                
                <div class="visit-content">
                    <div><strong>🩺 Chief Complaint:</strong></div>
                    <div style="margin: 0.5rem 0; padding: 1rem; background: #FEF3C7; border-radius: 6px; border-left: 4px solid #F59E0B;">
                        ${visit.ailment}
                    </div>
                    
                    ${visit.notes ? `
                        <div style="margin-top: 1rem;"><strong>📝 Additional Notes:</strong></div>
                        <div style="margin: 0.5rem 0; padding: 1rem; background: #EFF6FF; border-radius: 6px; border-left: 4px solid #3B82F6;">
                            ${visit.notes}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    }).join('');
}

function generateVitalsDisplay(visit) {
    const vitals = [];
    
    if (visit.bloodPressure) vitals.push({ label: 'Blood Pressure', value: visit.bloodPressure, icon: '❤️' });
    if (visit.weight) vitals.push({ label: 'Weight', value: visit.weight + ' kg', icon: '⚖️' });
    if (visit.height) vitals.push({ label: 'Height', value: visit.height + ' cm', icon: '📏' });
    if (visit.temperature) vitals.push({ label: 'Temperature', value: visit.temperature + '°C', icon: '🌡️' });
    if (visit.heartRate) vitals.push({ label: 'Heart Rate', value: visit.heartRate + ' bpm', icon: '💓' });
    
    if (vitals.length === 0) return '';
    
    return `
        <div class="visit-vitals">
            ${vitals.map(vital => `
                <div class="vital-item">
                    <div class="vital-label">${vital.icon} ${vital.label}</div>
                    <div class="vital-value">${vital.value}</div>
                </div>
            `).join('')}
        </div>
    `;
}

function getLastVital(patient, vitalType) {
    const visits = patient.visits || [];
    for (let i = visits.length - 1; i >= 0; i--) {
        if (visits[i][vitalType]) {
            return visits[i][vitalType];
        }
    }
    return '';
}

function recordQuickVisit(patient) {
    const formData = {
        bloodPressure: document.getElementById('quickBP')?.value || '',
        weight: document.getElementById('quickWeight')?.value || '',
        temperature: document.getElementById('quickTemp')?.value || '',
        heartRate: document.getElementById('quickHR')?.value || '',
        ailment: document.getElementById('quickAilment')?.value || '',
        notes: document.getElementById('quickNotes')?.value || ''
    };
    
    if (!formData.ailment.trim()) {
        showAlert('Please describe the ailment/complaint', 'warning');
        return;
    }
    
    const newVisit = {
        id: generateId(),
        patientId: patient.id,
        date: new Date().toISOString(),
        ailment: formData.ailment,
        notes: formData.notes,
        bloodPressure: formData.bloodPressure,
        weight: formData.weight,
        height: patient.height, // Carry forward height from registration
        temperature: formData.temperature,
        heartRate: formData.heartRate
    };
    
    // Ensure patient.visits array exists
    if (!patient.visits) {
        patient.visits = [];
    }
    
    patient.visits.push(newVisit);
    visits.push(newVisit);
    
    saveData();
    showAlert('✅ New visit recorded successfully!', 'success');
    
    // Refresh the patient dashboard
    setTimeout(() => {
        showPatientDashboard(patient.id);
        updateDashboard();
    }, 500);
}



// Show all patients view
function showAllPatients() {
    document.getElementById('patientsView').style.display = 'block';
    document.getElementById('individualPatientView').style.display = 'none';
    document.getElementById('breadcrumb').style.display = 'none';
    displayAllPatients();
}

function searchAllPatients() {
    filterPatientsByDepartment(); // This will handle both search and department filter
}

// MODIFY your existing displayAllPatients function to call the initialization:
const originalDisplayAllPatients = displayAllPatients;
function displayAllPatients() {
    // Initialize the enhanced interface first
    setTimeout(initializeDepartmentFilter, 100);
    
    // Then display patients
    setTimeout(() => {
        const patientsList = document.getElementById('patientsList');
        
        if (patients.length === 0) {
            patientsList.innerHTML = '<div class="alert alert-warning">No patients registered yet.</div>';
            return;
        }

        // Sort patients by last visit date (most recent first)
        const sortedPatients = [...patients].sort((a, b) => {
            const aLastVisit = a.visits.length > 0 ? new Date(a.visits[a.visits.length - 1].date) : new Date(0);
            const bLastVisit = b.visits.length > 0 ? new Date(b.visits[b.visits.length - 1].date) : new Date(0);
            return bLastVisit - aLastVisit;
        });

        displayFilteredPatientList(sortedPatients, '', '');
    }, 150);
}

// Advanced search functionality
function performSearch() {
    const searchName = document.getElementById('searchName').value.toLowerCase();
    const searchDept = document.getElementById('searchDepartment').value;
    const searchRole = document.getElementById('searchRole').value.toLowerCase();
    const searchEmpId = document.getElementById('searchEmployeeId').value.toLowerCase();

    let filteredPatients = patients;

    if (searchName) {
        filteredPatients = filteredPatients.filter(p => 
            p.name.toLowerCase().includes(searchName)
        );
    }

    if (searchDept) {
        filteredPatients = filteredPatients.filter(p => 
            p.department === searchDept
        );
    }

    if (searchRole) {
        filteredPatients = filteredPatients.filter(p => 
            p.role.toLowerCase().includes(searchRole)
        );
    }

    if (searchEmpId) {
        filteredPatients = filteredPatients.filter(p => 
            p.employeeId && p.employeeId.toLowerCase().includes(searchEmpId)
        );
    }

    displaySearchResults(filteredPatients);
}

function displaySearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">No patients found matching your criteria.</div>';
        return;
    }

    const resultsHtml = `
        <h3>Search Results (${results.length} found)</h3>
        ${results.map(patient => `
            <div class="patient-card" onclick="showPatientDetails('${patient.id}')">
                <div class="patient-header">
                    <div class="patient-name">${patient.name}</div>
                    <div class="visit-count">${patient.visits.length} visit(s)</div>
                </div>
                <div class="patient-details">
                    <div><strong>Department:</strong> ${patient.department}</div>
                    <div><strong>Role:</strong> ${patient.role}</div>
                    <div><strong>Employee ID:</strong> ${patient.employeeId || 'N/A'}</div>
                    <div><strong>Last Visit:</strong> ${patient.visits.length > 0 ? formatDate(patient.visits[patient.visits.length - 1].date) : 'N/A'}</div>
                </div>
            </div>
        `).join('')}
    `;

    resultsDiv.innerHTML = resultsHtml;
}

function showPatientDetails(patientId) {
    // Switch to All Patients tab and show individual patient dashboard
    showTab('allPatients');
    document.querySelector('[onclick="showTab(\'allPatients\')"]').classList.add('active');
    showPatientDashboard(patientId);
}

function clearSearch() {
    document.getElementById('searchName').value = '';
    document.getElementById('searchDepartment').value = '';
    document.getElementById('searchRole').value = '';
    document.getElementById('searchEmployeeId').value = '';
    document.getElementById('searchResults').innerHTML = '';
}

// Dashboard functions
function updateDashboard() {
    // Update statistics
    document.getElementById('totalPatients').textContent = patients.length;
    document.getElementById('totalVisits').textContent = visits.length;
    
    const departments = [...new Set(patients.map(p => p.department))];
    document.getElementById('totalDepartments').textContent = departments.length;

    const today = new Date().toDateString();
    const visitsToday = visits.filter(v => new Date(v.date).toDateString() === today).length;
    document.getElementById('visitsToday').textContent = visitsToday;

    // Update recent visits
    displayRecentVisits();
    
    // Update charts
    updateCharts();
}

function displayRecentVisits() {
    const recentVisitsDiv = document.getElementById('recentVisits');
    const recentVisits = visits
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);

    if (recentVisits.length === 0) {
        recentVisitsDiv.innerHTML = '<div class="alert alert-warning">No recent visits.</div>';
        return;
    }

    const visitsHtml = recentVisits.map(visit => {
        const patient = patients.find(p => p.id === visit.patientId);
        return `
            <div class="visit-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>${patient ? patient.name : 'Unknown Patient'}</strong>
                    <span>${formatDateTime(visit.date)}</span>
                </div>
                <div>Department: ${patient ? patient.department : 'N/A'}</div>
                <div>Ailment: ${visit.ailment}</div>
            </div>
        `;
    }).join('');

    recentVisitsDiv.innerHTML = visitsHtml;
}

function updateCharts() {
    // Small delay to ensure DOM is ready
    setTimeout(() => {
        updateDepartmentChart();
        updateMonthlyChart();
    }, 100);
}

function updateDepartmentChart() {
    // Get department data
    const departments = {};
    patients.forEach(patient => {
        departments[patient.department] = (departments[patient.department] || 0) + patient.visits.length;
    });

    const chartData = Object.entries(departments).map(([name, y]) => ({ name, y }));
    
    if (chartData.length === 0) {
        document.getElementById('departmentChart').innerHTML = '<div class="alert alert-warning">No data available for chart</div>';
        return;
    }

    Highcharts.chart('departmentChart', {
        chart: {
            type: 'column',
            backgroundColor: 'transparent',
            style: {
                fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif'
            }
        },
        title: {
            text: 'Visits by Department',
            style: {
                color: '#374151',
                fontSize: '18px',
                fontWeight: '600'
            }
        },
        subtitle: {
            text: `Total Visits: ${chartData.reduce((sum, item) => sum + item.y, 0)}`,
            style: {
                color: '#6B7280'
            }
        },
        xAxis: {
            type: 'category',
            labels: {
                rotation: -45,
                style: {
                    color: '#374151',
                    fontSize: '12px'
                }
            },
            lineColor: '#E5E7EB'
        },
        yAxis: {
            title: {
                text: 'Number of Visits',
                style: {
                    color: '#374151'
                }
            },
            labels: {
                style: {
                    color: '#374151'
                }
            },
            gridLineColor: '#F3F4F6'
        },
        tooltip: {
            headerFormat: '<span style="font-size:12px; font-weight:bold;">{point.key}</span><br>',
            pointFormat: '<b>{point.y}</b> visits<br>' +
                        '<span style="font-size:11px;">Click to view department details</span>',
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#E5E7EB',
            borderRadius: 8,
            shadow: true
        },
        plotOptions: {
            column: {
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '{point.y}',
                    style: {
                        color: '#374151',
                        fontSize: '12px',
                        fontWeight: 'bold',
                        textOutline: 'none'
                    }
                },
                borderRadius: 4,
                borderWidth: 0,
                point: {
                    events: {
                        click: function() {
                            showDepartmentDetails(this.name, this.y);
                        }
                    }
                }
            },
            series: {
                animation: {
                    duration: 1000
                }
            }
        },
        colors: ['#DC2626', '#1E40AF', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#3B82F6', '#06B6D4', '#84CC16', '#F97316'],
        series: [{
            name: 'Visits',
            colorByPoint: true,
            data: chartData
        }],
        credits: {
            enabled: false
        },
        exporting: {
            enabled: true,
            buttons: {
                contextButton: {
                    menuItems: ['viewFullscreen', 'separator', 'downloadPNG', 'downloadJPEG', 'downloadPDF']
                }
            }
        },
        responsive: {
            rules: [{
                condition: {
                    maxWidth: 500
                },
                chartOptions: {
                    xAxis: {
                        labels: {
                            rotation: -90
                        }
                    }
                }
            }]
        }
    });
}

function updateMonthlyChart() {
    // Get monthly data for current year
    const monthlyData = new Array(12).fill(0);
    const currentYear = new Date().getFullYear();
    
    visits.forEach(visit => {
        const visitDate = new Date(visit.date);
        if (visitDate.getFullYear() === currentYear) {
            monthlyData[visitDate.getMonth()]++;
        }
    });

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const chartData = months.map((month, index) => ({
        name: month,
        y: monthlyData[index]
    }));

    Highcharts.chart('monthlyChart', {
        chart: {
            type: 'spline',
            backgroundColor: 'transparent',
            style: {
                fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif'
            }
        },
        title: {
            text: `Monthly Visit Trends - ${currentYear}`,
            style: {
                color: '#374151',
                fontSize: '18px',
                fontWeight: '600'
            }
        },
        subtitle: {
            text: `Total visits this year: ${monthlyData.reduce((sum, count) => sum + count, 0)}`,
            style: {
                color: '#6B7280'
            }
        },
        xAxis: {
            categories: months,
            labels: {
                style: {
                    color: '#374151'
                }
            },
            lineColor: '#E5E7EB',
            tickColor: '#E5E7EB'
        },
        yAxis: {
            title: {
                text: 'Number of Visits',
                style: {
                    color: '#374151'
                }
            },
            labels: {
                style: {
                    color: '#374151'
                }
            },
            gridLineColor: '#F3F4F6',
            min: 0
        },
        tooltip: {
            headerFormat: '<span style="font-size:12px; font-weight:bold;">{point.key} {series.name}</span><br>',
            pointFormat: '<b>{point.y}</b> visits<br>' +
                        '<span style="font-size:11px;">Click to filter by this month</span>',
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#1E40AF',
            borderRadius: 8,
            shadow: true
        },
        plotOptions: {
            spline: {
                cursor: 'pointer',
                lineWidth: 3,
                marker: {
                    radius: 6,
                    fillColor: '#FFFFFF',
                    lineWidth: 2,
                    lineColor: '#DC2626',
                    states: {
                        hover: {
                            radius: 8,
                            lineWidth: 3
                        }
                    }
                },
                point: {
                    events: {
                        click: function() {
                            filterByMonth(this.x + 1); // +1 because months are 0-indexed
                        }
                    }
                },
                dataLabels: {
                    enabled: true,
                    format: '{point.y}',
                    style: {
                        color: '#374151',
                        fontSize: '11px',
                        fontWeight: 'bold',
                        textOutline: 'none'
                    }
                }
            },
            series: {
                animation: {
                    duration: 1200
                }
            }
        },
        series: [{
            name: currentYear,
            data: chartData,
            color: {
                linearGradient: {
                    x1: 0,
                    y1: 0,
                    x2: 0,
                    y2: 1
                },
                stops: [
                    [0, '#1E40AF'],
                    [1, '#DC2626']
                ]
            }
        }],
        credits: {
            enabled: false
        },
        exporting: {
            enabled: true,
            buttons: {
                contextButton: {
                    menuItems: ['viewFullscreen', 'separator', 'downloadPNG', 'downloadJPEG', 'downloadPDF']
                }
            }
        },
        responsive: {
            rules: [{
                condition: {
                    maxWidth: 500
                },
                chartOptions: {
                    chart: {
                        height: 300
                    },
                    plotOptions: {
                        spline: {
                            dataLabels: {
                                enabled: false
                            }
                        }
                    }
                }
            }]
        }
    });
}


function showDepartmentDetails(departmentName, visitCount) {
    const departmentPatients = patients.filter(p => p.department === departmentName);
    const recentVisits = visits
        .filter(v => {
            const patient = patients.find(p => p.id === v.patientId);
            return patient && patient.department === departmentName;
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);

    const modalContent = `
        <div style="text-align: center; margin-bottom: 1.5rem;">
            <h3 style="color: var(--primary-blue); margin: 0;">${departmentName} Department</h3>
            <p style="color: #6B7280; margin: 0.5rem 0;">Detailed Analytics</p>
        </div>
        
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card patients">
                <div class="stat-number">${departmentPatients.length}</div>
                <div class="stat-label">Employees</div>
            </div>
            <div class="stat-card visits">
                <div class="stat-number">${visitCount}</div>
                <div class="stat-label">Total Visits</div>
            </div>
            <div class="stat-card departments">
                <div class="stat-number">${departmentPatients.length > 0 ? (visitCount / departmentPatients.length).toFixed(1) : 0}</div>
                <div class="stat-label">Avg Visits/Employee</div>
            </div>
        </div>
        
        <h4>Recent Visits:</h4>
        ${recentVisits.map(visit => {
            const patient = patients.find(p => p.id === visit.patientId);
            return `
                <div class="visit-item" style="margin-bottom: 0.5rem;">
                    <div><strong>${patient ? patient.name : 'Unknown'}</strong> - ${formatDateTime(visit.date)}</div>
                    <div style="font-size: 0.9rem; color: #6B7280;">${visit.ailment}</div>
                </div>
            `;
        }).join('')}
        
        <div style="text-align: center; margin-top: 2rem;">
            <button onclick="filterByDepartment('${departmentName}')" class="btn">View All ${departmentName} Patients</button>
        </div>
    `;

    // Create and show modal
    showCustomModal('Department Analytics', modalContent);
}

function filterByMonth(monthNumber) {
    document.getElementById('monthFilter').value = monthNumber;
    filterData();
    showAlert(`Filtered to show ${getMonthName(monthNumber)} visits only`, 'success');
}

function filterByDepartment(departmentName) {
    showTab('search');
    document.querySelector('[onclick="showTab(\'search\')"]').classList.add('active');
    document.getElementById('searchDepartment').value = departmentName;
    performSearch();
}

function getMonthName(monthNumber) {
    const months = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    return months[monthNumber];
}

function showCustomModal(title, content) {
    // Create modal HTML
    const modalHTML = `
        <div id="customModal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close" onclick="closeCustomModal()">&times;</span>
                <div class="modal-header">
                    <h3>${title}</h3>
                </div>
                <div>${content}</div>
            </div>
        </div>
    `;
    
    // Add to body
    const modalDiv = document.createElement('div');
    modalDiv.innerHTML = modalHTML;
    document.body.appendChild(modalDiv);
}

function closeCustomModal() {
    const modal = document.getElementById('customModal');
    if (modal) {
        modal.parentElement.remove();
    }
}

// Enhanced day filter population
function populateDayFilter() {
    const dayFilter = document.getElementById('dayFilter');
    if (!dayFilter) return;
    
    // Clear existing options except "All Days"
    dayFilter.innerHTML = '<option value="">All Days</option>';
    
    for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        dayFilter.appendChild(option);
    }
}

// Filter by specific date
function filterBySpecificDate() {
    const specificDate = document.getElementById('specificDate').value;
    if (!specificDate) {
        updateDashboard();
        return;
    }
    
    const selectedDate = new Date(specificDate);
    const filteredVisits = visits.filter(v => {
        const visitDate = new Date(v.date);
        return visitDate.toDateString() === selectedDate.toDateString();
    });
    
    updateFilteredDashboard(filteredVisits);
    displayFilteredRecentVisits(filteredVisits);
}

// Enhanced filter data function
function filterData() {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    
    console.log('Filtering with:', { year, month, day }); // Debug log
    
    let filteredVisits = visits;
    
    if (year) {
        filteredVisits = filteredVisits.filter(v => new Date(v.date).getFullYear() == year);
    }
    
    if (month) {
        filteredVisits = filteredVisits.filter(v => new Date(v.date).getMonth() + 1 == month);
    }


    console.log('Filtered visits:', filteredVisits.length); // Debug log
    updateFilteredDashboard(filteredVisits);
    displayFilteredRecentVisits(filteredVisits);
}

// Display filtered recent visits
function displayFilteredRecentVisits(filteredVisits) {
    const recentVisitsDiv = document.getElementById('recentVisits');
    const recentVisits = filteredVisits
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 10);

    if (recentVisits.length === 0) {
        recentVisitsDiv.innerHTML = '<div class="alert alert-warning">No visits found for selected filters.</div>';
        return;
    }

    const visitsHtml = recentVisits.map(visit => {
        const patient = patients.find(p => p.id === visit.patientId);
        return `
            <div class="visit-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>${patient ? patient.name : 'Unknown Patient'}</strong>
                    <span>${formatDateTime(visit.date)}</span>
                </div>
                <div>Department: ${patient ? patient.department : 'N/A'}</div>
                <div>Ailment: ${visit.ailment}</div>
            </div>
        `;
    }).join('');

    recentVisitsDiv.innerHTML = visitsHtml;
}

// Enhanced reset filters
function resetFilters() {
    document.getElementById('yearFilter').value = '';
    document.getElementById('monthFilter').value = '';
    document.getElementById('specificDate').value = '';
    updateDashboard();
}

// Quick patient lookup for return visits
function quickPatientLookup() {
    const searchTerm = document.getElementById('quickSearch').value.toLowerCase();
    if (searchTerm.length < 2) return [];
    
    return patients.filter(patient => 
        patient.name.toLowerCase().includes(searchTerm) ||
        (patient.employeeId && patient.employeeId.toLowerCase().includes(searchTerm))
    ).slice(0, 5); // Show max 5 matches
}

// Patient visit statistics
function getPatientStats(patientId) {
    const patient = patients.find(p => p.id === patientId);
    if (!patient) return null;
    
    const visits = patient.visits;
    const now = new Date();
    
    return {
        totalVisits: visits.length,
        thisMonth: visits.filter(v => {
            const visitDate = new Date(v.date);
            return visitDate.getMonth() === now.getMonth() && 
                   visitDate.getFullYear() === now.getFullYear();
        }).length,
        lastVisit: visits.length > 0 ? visits[visits.length - 1].date : null,
        avgVisitsPerMonth: visits.length > 0 ? 
            visits.length / Math.max(1, Math.ceil((now - new Date(patient.registrationDate)) / (1000 * 60 * 60 * 24 * 30))) : 0
    };
}


// Filter functions
function populateYearFilter() {
    const yearFilter = document.getElementById('yearFilter');
    const years = [...new Set(visits.map(v => new Date(v.date).getFullYear()))].sort();
    
    years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
    });
}

function filterData() {
    const year = document.getElementById('yearFilter').value;
    const month = document.getElementById('monthFilter').value;
    
    let filteredVisits = visits;
    
    if (year) {
        filteredVisits = filteredVisits.filter(v => new Date(v.date).getFullYear() == year);
    }
    
    if (month) {
        filteredVisits = filteredVisits.filter(v => new Date(v.date).getMonth() + 1 == month);
    }

    // Update dashboard with filtered data
    updateFilteredDashboard(filteredVisits);
}

function updateFilteredDashboard(filteredVisits) {
    const filteredPatients = [...new Set(filteredVisits.map(v => v.patientId))]
        .map(id => patients.find(p => p.id === id))
        .filter(p => p);

    document.getElementById('totalPatients').textContent = filteredPatients.length;
    document.getElementById('totalVisits').textContent = filteredVisits.length;
    
    const departments = [...new Set(filteredPatients.map(p => p.department))];
    document.getElementById('totalDepartments').textContent = departments.length;

    const today = new Date().toDateString();
    const visitsToday = filteredVisits.filter(v => new Date(v.date).toDateString() === today).length;
    document.getElementById('visitsToday').textContent = visitsToday;
}

function resetFilters() {
    document.getElementById('yearFilter').value = '';
    document.getElementById('monthFilter').value = '';
    updateDashboard();
}


// Utility functions
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString();
}

function formatDateTime(dateString) {
    return new Date(dateString).toLocaleString();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.innerHTML = message;
    
    // Insert at the top of the active tab
    const activeTab = document.querySelector('.tab-content.active');
    activeTab.insertBefore(alertDiv, activeTab.firstChild);
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

function saveData() {
    try {
        localStorage.setItem('patients', JSON.stringify(patients));
        localStorage.setItem('visits', JSON.stringify(visits));
        localStorage.setItem('lastSaved', new Date().toISOString());
        console.log('Data saved successfully:', { patients: patients.length, visits: visits.length });
    } catch (error) {
        console.error('Error saving data:', error);
        showAlert('Error saving data. Please try again.', 'warning');
    }
}

function exportToExcel() {
    const fromDate = document.getElementById('reportFromDate').value;
    const toDate = document.getElementById('reportToDate').value;
    const department = document.getElementById('reportDepartment').value;
    
    // Show confirmation of what will be exported
    let filterDescription = 'Exporting: ';
    if (fromDate || toDate) {
        filterDescription += `Date range: ${fromDate || 'Beginning'} to ${toDate || 'Present'} • `;
    } else {
        filterDescription += 'All dates • ';
    }
    filterDescription += department ? `Department: ${department}` : 'All departments';
    
    if (!confirm(`${filterDescription}\n\nProceed with export?`)) {
        return;
    }
    
    // Filter data based on date range and department
    let filteredData = getFilteredReportData(fromDate, toDate, department);
    
    if (filteredData.length === 0) {
        showAlert('No data found matching your filter criteria!', 'warning');
        return;
    }
    
    // Generate CSV content
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Add headers
    csvContent += "Patient Name,Department,Role,Employee ID,Age,Registration Date,Visit Date,Ailment,Notes,Blood Pressure,Weight,Height,Temperature,Heart Rate\n";
    
    // Add filtered data
    filteredData.forEach(row => {
        const csvRow = [
            row.patientName,
            row.department,
            row.role,
            row.employeeId || '',
            row.age || '',
            formatDate(row.registrationDate),
            formatDate(row.visitDate),
            `"${row.ailment.replace(/"/g, '""')}"`, // Escape quotes in ailment
            `"${(row.notes || '').replace(/"/g, '""')}"`, // Escape quotes in notes
            row.bloodPressure || '',
            row.weight || '',
            row.height || '',
            row.temperature || '',
            row.heartRate || ''
        ].join(",");
        
        csvContent += csvRow + "\n";
    });

    // Create download link
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    
    // Generate filename with filter info
    const filterInfo = generateFilterInfo(fromDate, toDate, department);
    link.setAttribute("download", `UAC_FOODS_Clinic_Data_${filterInfo}_${new Date().toISOString().split('T')[0]}.csv`);
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert(`✅ Data exported successfully! (${filteredData.length} records)`, 'success');
    
    // Show preview of exported data
    showExportPreview(filteredData, fromDate, toDate, department);
}

function showExportPreview(data, fromDate, toDate, department) {
    const previewDiv = document.getElementById('reportPreview');
    
    const summary = {
        totalRecords: data.length,
        totalPatients: [...new Set(data.map(d => d.patientName))].length,
        departments: [...new Set(data.map(d => d.department))],
        dateRange: {
            earliest: data.length > 0 ? new Date(Math.min(...data.map(d => new Date(d.visitDate)))).toDateString() : 'N/A',
            latest: data.length > 0 ? new Date(Math.max(...data.map(d => new Date(d.visitDate)))).toDateString() : 'N/A'
        }
    };
    
    // Create filter summary
    let filterSummary = [];
    if (fromDate) filterSummary.push(`From: ${formatDate(fromDate)}`);
    if (toDate) filterSummary.push(`To: ${formatDate(toDate)}`);
    if (department) filterSummary.push(`Department: ${department}`);
    if (filterSummary.length === 0) filterSummary.push('All data exported');
    
    previewDiv.innerHTML = `
        <div class="chart-container">
            <h3>📊 Export Summary</h3>
            <div class="alert alert-success">
                <strong>Export Completed Successfully!</strong><br>
                🔍 Filters Applied: ${filterSummary.join(' • ')}<br>
                📅 Actual Date Range: ${summary.dateRange.earliest} to ${summary.dateRange.latest}<br>
                🏢 Departments: ${summary.departments.join(', ')}<br>
                📁 File contains ${summary.totalRecords} visit records from ${summary.totalPatients} patients
            </div>
            <div class="stats-grid">
                <div class="stat-card visits">
                    <div class="stat-number">${summary.totalRecords}</div>
                    <div class="stat-label">Visit Records</div>
                </div>
                <div class="stat-card patients">
                    <div class="stat-number">${summary.totalPatients}</div>
                    <div class="stat-label">Unique Patients</div>
                </div>
                <div class="stat-card departments">
                    <div class="stat-number">${summary.departments.length}</div>
                    <div class="stat-label">Departments</div>
                </div>
                <div class="stat-card today">
                    <div class="stat-number">${Math.ceil((new Date(summary.dateRange.latest) - new Date(summary.dateRange.earliest)) / (1000 * 60 * 60 * 24)) || 0}</div>
                    <div class="stat-label">Day Range</div>
                </div>
            </div>
        </div>
    `;
}

// ADD these new helper functions for the enhanced export:

function getFilteredReportData(fromDate, toDate, department) {
    let filteredData = [];
    
    patients.forEach(patient => {
        // Filter by department if specified
        if (department && patient.department !== department) {
            return;
        }
        
        patient.visits.forEach(visit => {
            const visitDate = new Date(visit.date);
            
            // Filter by date range if specified
            if (fromDate && visitDate < new Date(fromDate)) {
                return;
            }
            if (toDate && visitDate > new Date(toDate)) {
                return;
            }
            
            // Add to filtered data
            filteredData.push({
                patientName: patient.name,
                department: patient.department,
                role: patient.role,
                employeeId: patient.employeeId,
                age: patient.age,
                registrationDate: patient.registrationDate,
                visitDate: visit.date,
                ailment: visit.ailment,
                notes: visit.notes,
                bloodPressure: visit.bloodPressure,
                weight: visit.weight,
                height: visit.height,
                temperature: visit.temperature,
                heartRate: visit.heartRate
            });
        });
    });
    
    return filteredData;
}

function generateFilterInfo(fromDate, toDate, department) {
    let filterInfo = [];
    
    if (fromDate) filterInfo.push(`From_${fromDate}`);
    if (toDate) filterInfo.push(`To_${toDate}`);
    if (department) filterInfo.push(department.replace(/\s+/g, '_'));
    
    return filterInfo.length > 0 ? filterInfo.join('_') : 'All_Data';
}

function showExportPreview(data) {
    const previewDiv = document.getElementById('reportPreview');
    
    const summary = {
        totalRecords: data.length,
        totalPatients: [...new Set(data.map(d => d.patientName))].length,
        departments: [...new Set(data.map(d => d.department))],
        dateRange: {
            earliest: data.length > 0 ? new Date(Math.min(...data.map(d => new Date(d.visitDate)))).toDateString() : 'N/A',
            latest: data.length > 0 ? new Date(Math.max(...data.map(d => new Date(d.visitDate)))).toDateString() : 'N/A'
        }
    };
    
    previewDiv.innerHTML = `
        <div class="chart-container">
            <h3>📊 Export Summary</h3>
            <div class="stats-grid">
                <div class="stat-card visits">
                    <div class="stat-number">${summary.totalRecords}</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card patients">
                    <div class="stat-number">${summary.totalPatients}</div>
                    <div class="stat-label">Unique Patients</div>
                </div>
                <div class="stat-card departments">
                    <div class="stat-number">${summary.departments.length}</div>
                    <div class="stat-label">Departments</div>
                </div>
                <div class="stat-card today">
                    <div class="stat-number">${summary.dateRange.earliest === summary.dateRange.latest ? '1 Day' : 'Multi-Day'}</div>
                    <div class="stat-label">Date Range</div>
                </div>
            </div>
            <div class="alert alert-success">
                <strong>Export Details:</strong><br>
                📅 Date Range: ${summary.dateRange.earliest} to ${summary.dateRange.latest}<br>
                🏢 Departments: ${summary.departments.join(', ')}<br>
                📁 File exported successfully with ${summary.totalRecords} records
            </div>
        </div>
    `;
}

function showDeletePatientModal() {
    document.getElementById('deletePatientModal').style.display = 'block';
    document.getElementById('deleteSearchInput').focus();
}

function closeDeleteModal() {
    document.getElementById('deletePatientModal').style.display = 'none';
    document.getElementById('deleteSearchInput').value = '';
    document.getElementById('deleteSearchResults').innerHTML = '';
}

function searchPatientsForDelete() {
    const searchTerm = document.getElementById('deleteSearchInput').value.toLowerCase();
    const resultsDiv = document.getElementById('deleteSearchResults');
    
    if (searchTerm.length < 2) {
        resultsDiv.innerHTML = '<p style="text-align: center; color: #6B7280; padding: 1rem;">Type at least 2 characters to search...</p>';
        return;
    }
    
    const matchingPatients = patients.filter(patient => 
        patient.name.toLowerCase().includes(searchTerm) ||
        patient.department.toLowerCase().includes(searchTerm) ||
        (patient.employeeId && patient.employeeId.toLowerCase().includes(searchTerm))
    );
    
    if (matchingPatients.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">No patients found matching your search.</div>';
        return;
    }
    
    const resultsHtml = matchingPatients.map(patient => {
        const lastVisit = patient.visits.length > 0 ? patient.visits[patient.visits.length - 1] : null;
        
        return `
            <div class="delete-patient-item" onclick="confirmDeletePatient('${patient.id}')">
                <div class="delete-patient-name">${patient.name}</div>
                <div class="delete-patient-details">
                    <div><strong>Dept:</strong> ${patient.department}</div>
                    <div><strong>Role:</strong> ${patient.role}</div>
                    <div><strong>ID:</strong> ${patient.employeeId || 'N/A'}</div>
                    <div><strong>Visits:</strong> ${patient.visits.length}</div>
                    <div><strong>Last Visit:</strong> ${lastVisit ? formatDate(lastVisit.date) : 'None'}</div>
                    <div><strong>Registered:</strong> ${formatDate(patient.registrationDate)}</div>
                </div>
            </div>
        `;
    }).join('');
    
    resultsDiv.innerHTML = resultsHtml;
}

function confirmDeletePatient(patientId) {
    const patient = patients.find(p => p.id === patientId);
    if (!patient) {
        showAlert('Patient not found!', 'warning');
        return;
    }
    
    const patientVisitCount = patient.visits.length;
    
    const confirmMessage = `⚠️ CRITICAL WARNING ⚠️\n\n` +
                          `You are about to permanently delete:\n\n` +
                          `👤 Patient: ${patient.name}\n` +
                          `🏢 Department: ${patient.department}\n` +
                          `📋 Total Visits: ${patientVisitCount}\n` +
                          `📅 Registration: ${formatDate(patient.registrationDate)}\n\n` +
                          `This will permanently remove:\n` +
                          `• All patient information\n` +
                          `• Complete medical history\n` +
                          `• All visit records\n\n` +
                          `THIS ACTION CANNOT BE UNDONE!\n\n` +
                          `Type "DELETE ${patient.name.toUpperCase()}" to confirm:`;
    
    const confirmation = prompt(confirmMessage);
    const expectedConfirmation = `DELETE ${patient.name.toUpperCase()}`;
    
    if (confirmation === expectedConfirmation) {
        // Count visits before deletion for confirmation
        const visitsToDelete = visits.filter(v => v.patientId === patientId).length;
        
        // Remove all visits for this patient from visits array
        visits = visits.filter(v => v.patientId !== patientId);
        
        // Remove the patient from patients array
        patients = patients.filter(p => p.id !== patientId);
        
        // Force save to database immediately
        saveData();
        
        // Verify deletion worked
        const remainingVisits = visits.filter(v => v.patientId === patientId);
        const remainingPatient = patients.find(p => p.id === patientId);
        
        if (remainingVisits.length === 0 && !remainingPatient) {
            // Update dashboard and close modal
            updateDashboard();
            closeDeleteModal();
            displayAllPatients();
            
            showAlert(`✅ SUCCESS: Patient "${patient.name}" and ${visitsToDelete} visit records permanently deleted from database.`, 'success');
            
            // Log for debugging
            console.log(`Deleted patient ${patient.name} (ID: ${patientId}) and ${visitsToDelete} visits`);
            console.log(`Remaining patients: ${patients.length}, Remaining visits: ${visits.length}`);
        } else {
            showAlert('❌ Error: Deletion may not have completed properly. Please refresh and try again.', 'warning');
        }
    } else if (confirmation !== null) {
        showAlert(`❌ Deletion cancelled. You must type exactly: "DELETE ${patient.name.toUpperCase()}" to confirm.`, 'warning');
    }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('deletePatientModal');
    if (event.target === modal) {
        closeDeleteModal();
    }
}

// Auto-save functionality
setInterval(() => {
    if (patients.length > 0 || visits.length > 0) {
        saveData();
    }
}, 30000); // Auto-save every 30 seconds

// Prevent data loss on page unload
window.addEventListener('beforeunload', function() {
    saveData();
});

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case '1':
                e.preventDefault();
                showTab('dashboard');
                document.querySelector('[onclick="showTab(\'dashboard\')"]').classList.add('active');
                break;
            case '2':
                e.preventDefault();
                showTab('newPatient');
                document.querySelector('[onclick="showTab(\'newPatient\')"]').classList.add('active');
                break;
            case '3':
                e.preventDefault();
                showTab('allPatients');
                document.querySelector('[onclick="showTab(\'allPatients\')"]').classList.add('active');
                break;
            case '4':
                e.preventDefault();
                showTab('search');
                document.querySelector('[onclick="showTab(\'search\')"]').classList.add('active');
                break;
            case '5':
                e.preventDefault();
                showTab('reports');
                document.querySelector('[onclick="showTab(\'reports\')"]').classList.add('active');
                break;
        }
    }
});

// Enhanced error handling
window.addEventListener('error', function(e) {
    console.error('Application error:', e.error);
});

// Responsive design enhancements
function handleResize() {
    const container = document.querySelector('.container');
    if (window.innerWidth < 768) {
        container.style.padding = '0 0.5rem';
    } else {
        container.style.padding = '0 1rem';
    }
}

window.addEventListener('resize', handleResize);
handleResize(); // Call on load

// Data validation functions
function validatePatientData(data) {
    const errors = [];
    
    if (!data.name || data.name.trim().length < 2) {
        errors.push('Patient name must be at least 2 characters long');
    }
    
    if (!data.department) {
        errors.push('Department is required');
    }
    
    if (!data.role || data.role.trim().length < 2) {
        errors.push('Role must be at least 2 characters long');
    }
    
    if (!data.ailment || data.ailment.trim().length < 5) {
        errors.push('Ailment description must be at least 5 characters long');
    }
    
    return errors;
}

// Data backup and restore functionality
function backupData() {
    const backup = {
        patients: patients,
        visits: visits,
        timestamp: new Date().toISOString(),
        version: '1.0'
    };
    
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `UAC_FOODS_Clinic_Backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showAlert('Data backup created successfully!', 'success');
}

function restoreData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            if (backup.patients && backup.visits) {
                if (confirm('This will replace all current data. Are you sure?')) {
                    patients = backup.patients;
                    visits = backup.visits;
                    saveData();
                    updateDashboard();
                    displayAllPatients();
                    showAlert('Data restored successfully!', 'success');
                }
            } else {
                showAlert('Invalid backup file format!', 'warning');
            }
        } catch (error) {
            showAlert('Error reading backup file!', 'warning');
        }
    };
    reader.readAsText(file);
}

// Clear all data function
function clearAllData() {
    if (confirm('Are you sure you want to clear all patient data? This action cannot be undone.')) {
        if (confirm('This will permanently delete all patients and visits. Continue?')) {
            patients = [];
            visits = [];
            localStorage.removeItem('patients');
            localStorage.removeItem('visits');
            updateDashboard();
            displayAllPatients();
            showAlert('All data cleared successfully!', 'success');
        }
    }
}

// Export individual patient data
function exportPatientData(patientId) {
    const patient = patients.find(p => p.id === patientId);
    if (!patient) return;

    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Visit Date,Ailment,Notes,Blood Pressure,Weight,Height\n";
    
    patient.visits.forEach(visit => {
        const row = [
            formatDate(visit.date),
            visit.ailment,
            visit.notes || '',
            visit.bloodPressure || '',
            visit.weight || '',
            visit.height || ''
        ].map(field => `"${field}"`).join(",");
        
        csvContent += row + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `${patient.name.replace(/\s+/g, '_')}_Medical_History.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Search functionality enhancements
function highlightSearchResults(text, searchTerm) {
    if (!searchTerm) return text;
    
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<mark style="background: #FEF3C7; padding: 2px 4px; border-radius: 3px;">$1</mark>');
}

// Patient analytics
function getPatientAnalytics(patientId) {
    const patient = patients.find(p => p.id === patientId);
    if (!patient) return null;

    const visits = patient.visits.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    return {
        totalVisits: visits.length,
        firstVisit: visits[0]?.date,
        lastVisit: visits[visits.length - 1]?.date,
        commonAilments: getCommonAilments(visits),
        visitFrequency: calculateVisitFrequency(visits),
        healthTrends: analyzeHealthTrends(visits)
    };
}

function getCommonAilments(visits) {
    const ailmentCounts = {};
    visits.forEach(visit => {
        const ailment = visit.ailment.toLowerCase();
        ailmentCounts[ailment] = (ailmentCounts[ailment] || 0) + 1;
    });
    
    return Object.entries(ailmentCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 3)
        .map(([ailment, count]) => ({ ailment, count }));
}

// STEP 3: UPDATE the calculateVisitFrequency function to handle empty arrays:
function calculateVisitFrequency(visits) {
    if (!visits || visits.length < 2) return 'Insufficient data';
    
    const firstVisit = new Date(visits[0].date);
    const lastVisit = new Date(visits[visits.length - 1].date);
    const daysDiff = (lastVisit - firstVisit) / (1000 * 60 * 60 * 24);
    const avgDaysBetweenVisits = daysDiff / (visits.length - 1);
    
    if (avgDaysBetweenVisits < 30) return 'High frequency (monthly or more)';
    if (avgDaysBetweenVisits < 90) return 'Moderate frequency (quarterly)';
    if (avgDaysBetweenVisits < 180) return 'Low frequency (bi-annually)';
    return 'Very low frequency (annually or less)';
}

function analyzeHealthTrends(visits) {
    const trends = {
        bloodPressure: 'stable',
        weight: 'stable'
    };

    // Analyze blood pressure trend
    const bpReadings = visits.filter(v => v.bloodPressure).map(v => {
        const [systolic, diastolic] = v.bloodPressure.split('/').map(Number);
        return { systolic, diastolic, date: new Date(v.date) };
    });

    if (bpReadings.length >= 2) {
        const recent = bpReadings.slice(-3);
        const early = bpReadings.slice(0, 3);
        
        const recentAvgSys = recent.reduce((sum, r) => sum + r.systolic, 0) / recent.length;
        const earlyAvgSys = early.reduce((sum, r) => sum + r.systolic, 0) / early.length;
        
        if (recentAvgSys > earlyAvgSys + 10) trends.bloodPressure = 'increasing';
        else if (recentAvgSys < earlyAvgSys - 10) trends.bloodPressure = 'decreasing';
    }

    // Analyze weight trend
    const weightReadings = visits.filter(v => v.weight && !isNaN(v.weight)).map(v => ({
        weight: parseFloat(v.weight),
        date: new Date(v.date)
    }));

    if (weightReadings.length >= 2) {
        const recent = weightReadings.slice(-3);
        const early = weightReadings.slice(0, 3);
        
        const recentAvgWeight = recent.reduce((sum, r) => sum + r.weight, 0) / recent.length;
        const earlyAvgWeight = early.reduce((sum, r) => sum + r.weight, 0) / early.length;
        
        if (recentAvgWeight > earlyAvgWeight + 2) trends.weight = 'increasing';
        else if (recentAvgWeight < earlyAvgWeight - 2) trends.weight = 'decreasing';
    }

    return trends;
}

// Advanced search with date range
function searchByDateRange(startDate, endDate) {
    const filteredVisits = visits.filter(visit => {
        const visitDate = new Date(visit.date);
        const start = new Date(startDate);
        const end = new Date(endDate);
        return visitDate >= start && visitDate <= end;
    });

    const patientIds = [...new Set(filteredVisits.map(v => v.patientId))];
    const filteredPatients = patients.filter(p => patientIds.includes(p.id));
    
    return { patients: filteredPatients, visits: filteredVisits };
}

// Get system statistics
function getSystemStats() {
    return {
        totalPatients: patients.length,
        totalVisits: visits.length,
        dataSize: JSON.stringify({patients, visits}).length,
        lastSaved: localStorage.getItem('lastSaved') || 'Never',
        browserSupport: {
            localStorage: typeof(Storage) !== "undefined",
            canvas: !!document.createElement('canvas').getContext,
            fileAPI: window.File && window.FileReader && window.FileList && window.Blob
        }
    };
}

// Initialize on DOM load
document.addEventListener('DOMContentLoaded', function() {
    updateDashboard();
    populateYearFilter();
    displayAllPatients();
    
    
});


console.log('🏥 UAC FOODS Clinic Management System loaded successfully!');

    </script>
</body>
</html>